# FlowDraw 流程图设计工具详细说明文档

## 项目概述

FlowDraw 是一款专注于流程图设计的绘图工具，基于 Qt 框架开发，提供丰富的几何图形和连接线功能，使用户能够便捷地创建各类流程图、组织结构图等。本工具采用直观的操作界面，同时支持编辑功能和多种导出选项。

## 功能详述

### 图形元素

#### 基础图形
- **矩形 (Rect)**: 标准四边形，常用于表示处理步骤或数据
- **椭圆 (Ellipse)**: 用于表示开始/结束点或连接点
- **菱形 (Diamond)**: 通常用于决策节点
- **三角形 (Triangle)**: 可用于指示方向或特殊处理

#### 高级图形
- **五边形 (Pentagon)**: 多用于表示特殊流程节点
- **六边形 (Hexagon)**: 适合表示预处理或初始化操作
- **八边形 (Octagon)**: 可用于表示停止或终止条件
- **圆角矩形 (RoundedRect)**: 视觉上更柔和的处理块
- **胶囊形 (Capsule)**: 适合表示函数或方法
- **直角三角形 (RectTriangle)**: 用于特殊指示或方向标识

#### 连接元素
- **连接线 (Connector)**: 支持单向和双向箭头
- **自动吸附**: 连接线会自动连接到图形的最近边缘点

### 编辑功能

#### 基本操作
- **选择**: 单击选择单个图形
- **移动**: 拖拽移动图形位置
- **调整大小**: 通过控制拖拽边缘调整图形尺寸
- **复制/粘贴**: 支持图形的复制和粘贴
- **删除**: 移除选中的图形

#### 属性编辑
- **填充颜色**: 自定义图形的填充颜色
- **描边颜色**: 设置图形轮廓的颜色
- **线条宽度**: 调整边框线的粗细
- **文本编辑**: 为图形添加说明文字
- **文本样式**: 自定义文本颜色和大小

#### 图层控制
- **置于顶层**: 将选中图形移至最上层
- **置于底层**: 将选中图形移至最下层
- **上移一层**: 微调图形层级顺序
- **下移一层**: 微调图形层级顺序

#### 撤销/重做
- **多级撤销**: 支持撤销多步操作
- **多级重做**: 支持重做已撤销的操作

### 视图控制

#### 缩放功能
- **放大**: 增大画布显示比例
- **缩小**: 减小画布显示比例
- **适应窗口**: 自动调整缩放以适应窗口大小
- **重置视图**: 恢复默认显示比例

#### 网格与对齐
- **网格显示**: 可显示或隐藏网格线

#### 页面设置
- **背景颜色**: 自定义画布背景色
- **页面大小**: 设置页面的宽度和高度
- **页面边界**: 显示页面边界线

### 文件操作

#### 保存与加载
- **专有格式**: 使用 .flow 格式保存完整图表数据
- **加载图表**: 从已保存的 .flow 文件中加载图表
- **状态保存**: 包括图形位置、属性和连接关系

#### 导出功能
- **PNG 导出**: 导出为位图格式
- **SVG 导出**: 导出为可缩放的矢量图形

#### 新建操作
- **新建图表**: 创建空白图表
- **清空画布**: 移除当前画布上的所有内容

## 技术架构

### 核心组件分析

#### 1. MainWindow 类
- **功能**: 提供主窗口框架，包括菜单栏、工具栏和状态栏
- **关键方法**: 
  - `MainWindow::MainWindow()`: 构造函数，初始化UI
  - 各种菜单和工具栏事件的连接
- **依赖关系**: 包含 FlowView 和 PropertyPanel 的实例

#### 2. FlowView 类
- **功能**: 核心绘图区域，处理用户交互和图形渲染
- **关键方法**: 
  - `paintEvent()`: 处理所有绘制逻辑
  - `mousePressEvent()`, `mouseMoveEvent()`, `mouseReleaseEvent()`: 处理鼠标事件
  - `saveToFile()`, `loadFromFile()`: 文件操作
  - `exportToPng()`, `exportToSvg()`: 导出功能
- **数据结构**:
  - `std::vector<std::unique_ptr<Shape>> shapes_`: 存储所有图形
  - `std::vector<Connector> connectors_`: 存储所有连接线
- **状态管理**:
  - `undoStack_`, `redoStack_`: 撤销和重做栈
  - `selectedIndex_`: 当前选中的图形索引
  - `viewOffset_`, `scale_`: 视图变换参数

#### 3. PropertyPanel 类
- **功能**: 提供图形属性编辑界面
- **关键方法**: 
  - 属性变更事件的信号发射
  - UI元素的初始化和更新
- **UI元素**: 颜色选择器、宽度调节器、文本编辑框等

#### 4. Shape 类继承体系
- **基类 Shape**: 定义所有可绘制元素的共同接口
  - `virtual void paint(QPainter& p, bool selected) const`: 绘制方法
  - `virtual bool hitTest(const QPointF& pt) const`: 碰撞检测
  - `virtual QJsonObject toJson() const`: 序列化
  - `virtual void fromJson(const QJsonObject&)`: 反序列化
- **派生类**:
  - `Rect`, `Ellipse`, `Diamond` 等: 实现特定图形的绘制逻辑

### 数据流分析

#### 用户交互流程
1. 用户通过工具栏选择绘图工具
2. FlowView 接收工具模式设置 (`setToolMode`)
3. 用户在画布上进行绘制操作
4. FlowView 捕获鼠标事件并创建对应图形
5. 用户编辑图形属性
6. 属性变更通过信号-槽传递给图形对象

#### 文件操作流程
1. 保存操作:
   - 将所有图形和连接线序列化为JSON对象
   - 写入文件系统
2. 加载操作:
   - 读取JSON数据
   - 解析并重建图形和连接线对象
3. 导出操作:
   - 创建离屏渲染表面
   - 绘制所有图形和连接线
   - 保存为目标格式

#### 撤销/重做机制
1. 每次操作前保存当前状态
2. 执行操作后记录新状态
3. 创建 ActionRecord 并压入 undoStack_
4. 撤销时从 undoStack_ 弹出记录并恢复状态
5. 恢复的状态同时压入 redoStack_

### 代码结构与组织

#### 项目目录结构
- **app/**: 主应用程序代码
  - **main.cpp**: 程序入口点
  - **MainWindow.hpp/cpp**: 主窗口实现
  - **FlowView.hpp/cpp**: 绘图视图实现
  - **PropertyPanel.hpp/cpp**: 属性面板实现
  - **model/**: 数据模型目录
    - **Shape.hpp**: 图形基类定义
    - 各种具体图形类的实现文件
  - **resources/**: 资源文件
    - **icons/**: 图标资源
    - **resources.qrc**: Qt资源配置文件
- **CMakeLists.txt**: 项目构建配置

## 使用指南

### 基本操作流程

#### 创建流程图
1. 启动 FlowDraw 应用程序
2. 从"形状"工具菜单选择需要的图形
3. 在画布上单击并拖动创建图形
4. 双击图形添加文本说明
5. 使用"连接器"工具连接相关图形
6. 调整图形位置和属性，完善流程图

#### 编辑图形属性
1. 单击选中要编辑的图形
2. 在属性面板中修改填充色、边框色和线宽
3. 调整文本属性，如字体大小和颜色
4. 使用控制手柄调整图形大小
5. 拖动图形调整位置

#### 连接图形
1. 选择"连接器"工具
2. 点击选择第一个图形作为起点
3. 拖拽到第二个图形作为终点
4. 连接线会自动找到最合适的连接点
5. 选中连接线后可调整其属性
6. 正反操作可以设置箭头方向（单向或双向）

#### 保存与分享
1. 使用"保存"功能将图表保存为 .flow 格式
2. 使用"导出PNG"将图表导出为图片格式
3. 使用"导出SVG"将图表导出为矢量图形
4. 分享导出的图片或SVG文件

### 高级技巧

#### 高效操作
- 使用快捷键提高工作效率
- 利用复制/粘贴批量创建相似图形
- 使用网格辅助精确定位图形
- 控制图层顺序优化视觉效果

#### 视图调整
- 使用缩放功能查看大型图表
- 调整页面大小适应不同内容
- 自定义背景颜色提高可读性
- 使用"适应窗口"功能获得最佳视图

#### 撤销/重做技巧
- 频繁使用撤销功能试验不同设计
- 结合使用撤销和重做进行比较
- 在进行大幅修改前保存文件

## 开发与扩展

### 代码结构分析

#### 关键类及职责
- **MainWindow**: 整体UI框架和菜单功能
- **FlowView**: 核心绘图逻辑和交互处理
- **Shape及其派生类**: 图形渲染和行为定义
- **Connector**: 连接线的逻辑和渲染
- **PropertyPanel**: 图形属性的UI交互

#### 扩展点
- **添加新图形**: 继承Shape类并实现必要方法
- **增强连接线功能**: 修改Connector类
- **添加新工具**: 扩展ToolMode枚举和相应处理逻辑
- **增加新属性**: 扩展Shape基类和属性面板

### 未来开发路线图

#### 近期规划
- 增强文本编辑能力，支持富文本格式
- 添加更多预设图形模板和连接样式
- 优化用户界面，提高操作流畅度
- 实现更智能的连接线路径算法
- 添加协作编辑功能
- 提供模板库
- 开发自动布局算法

#### 长期愿景
- 构建生态系统，支持插件扩展
- 提供专业版本增强功能
- 开发移动端适配版本
- 跨平台支持与一致体验

## 附录

### 命令行参数
FlowDraw 目前不支持命令行参数，直接运行可启动应用程序。

### 快捷键列表
| 操作 | 快捷键 |
|------|--------|
| 新建 | Ctrl+N |
| 打开 | Ctrl+O |
| 保存 | Ctrl+S |
| 撤销 | Ctrl+Z |
| 重做 | Ctrl+Y |
| 剪切 | Ctrl+X |
| 复制 | Ctrl+C |
| 粘贴 | Ctrl+V |
| 删除 | Delete |
| 置于顶层 | Ctrl+] |
| 置于底层 | Ctrl+[ |
| 放大 | Ctrl++ |
| 缩小 | Ctrl+- |
| 重置缩放 | Ctrl+0 |
| 适应窗口 | Ctrl+F |

### 技术规格
- **编程语言**: C++
- **图形框架**: Qt 5.12+
- **构建系统**: CMake
- **目标平台**: Windows, macOS, Linux
- **最低系统要求**: 
  - 支持OpenGL 2.0的显卡
  - 4GB RAM
  - 100MB磁盘空间

### 版本历史
FlowDraw 目前处于MVP(最小可行产品)阶段，版本号为0.1.0。 